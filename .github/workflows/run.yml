name: Feishu Asset Monitor (Scraper)

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch:

# å…³é”®ï¼šèµ‹äºˆ Action å†™å…¥ä»“åº“çš„æƒé™ï¼Œç”¨äºä¿å­˜çŠ¶æ€æ–‡ä»¶
permissions:
  contents: write 

jobs:
  check-wallet:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        # è¿™é‡Œä¼šå®‰è£… requests, beautifulsoup4, lxml
        run: pip install -r requirements.txt 

      - name: è¿è¡Œç›‘æ§è„šæœ¬
        env:
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        # æˆ‘ä»¬çš„è„šæœ¬ä¼šè¯»å–çŠ¶æ€å¹¶å†™å…¥æ–°çš„çŠ¶æ€
        run: python monitor.py
        
      # === å…³é”®ï¼šGit æäº¤æ–°çŠ¶æ€ ===
      - name: é…ç½® Git ç¯å¢ƒ
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: æäº¤æ–°çŠ¶æ€æ–‡ä»¶
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦è¢«æäº¤ï¼ˆå³ monitor.py å†™å…¥äº†æ–°çš„ txidï¼‰
          if git diff --exit-code last_asset_tx_id.txt; then
            echo "çŠ¶æ€æ–‡ä»¶æœªæ”¹å˜ï¼Œæ— éœ€æäº¤ã€‚"
          else
            git add last_asset_tx_id.txt
            git commit -m "ğŸ¤– [Bot] Update last known asset transaction ID"
            git push
            echo "æ–°çŠ¶æ€å·²æäº¤åˆ°ä»“åº“ã€‚"
          fi
