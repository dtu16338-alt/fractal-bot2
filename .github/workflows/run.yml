name: Feishu Asset Monitor (Playwright)

on:
  schedule:
    # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
    - cron: '0 * * * *'
  workflow_dispatch:

# å…³é”®ï¼šèµ‹äºˆ Action å†™å…¥ä»“åº“çš„æƒé™ï¼Œç”¨äºä¿å­˜çŠ¶æ€æ–‡ä»¶
permissions:
  contents: write 

jobs:
  check-wallet:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v3

      - name: è®¾ç½® Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: å®‰è£…ä¾èµ–
        run: pip install -r requirements.txt 
        
      # === å…³é”®æ­¥éª¤ï¼šå®‰è£… Playwright ä¾èµ–çš„æµè§ˆå™¨ ===
      - name: å®‰è£… Playwright æµè§ˆå™¨
        run: playwright install chromium

      - name: è¿è¡Œç›‘æ§è„šæœ¬
        env:
          WALLET_ADDRESS: ${{ secrets.WALLET_ADDRESS }}
          FEISHU_WEBHOOK: ${{ secrets.FEISHU_WEBHOOK }}
        run: python monitor.py
        
      # === Git æäº¤æ–°çŠ¶æ€ ===
      - name: é…ç½® Git ç¯å¢ƒ
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
      - name: æäº¤æ–°çŠ¶æ€æ–‡ä»¶
        run: |
          if [ -f last_asset_tx_id.txt ]; then
            git add last_asset_tx_id.txt
            if [[ $(git status --porcelain) ]]; then
              git commit -m "ğŸ¤– [Bot] Update last known asset transaction ID"
              git push
              echo "âœ… æ–°çŠ¶æ€å·²æäº¤åˆ°ä»“åº“ã€‚"
            else
              echo "çŠ¶æ€æ–‡ä»¶æœªæ”¹å˜ï¼Œæ— éœ€æäº¤ã€‚"
            fi
          else
            echo "è­¦å‘Šï¼šmonitor.py æœªèƒ½å†™å…¥çŠ¶æ€æ–‡ä»¶ï¼Œæ— æ³•æäº¤ã€‚è¯·æ£€æŸ¥è„šæœ¬æ—¥å¿—ã€‚"
          fi
